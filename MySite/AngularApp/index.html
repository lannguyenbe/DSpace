<!doctype html>
<html ng-app="typaApp">
<head>
  <meta charset="utf-8">
  <title>Type Ahead</title>
  <link rel="stylesheet" type="text/css" href="css/typa.css" />
  <script src="angular/1.3.10/angular.js"></script>
  <script src="angular/1.3.10/angular-resource.js"></script>
  <script>
  angular.module('nln.ui.utils',[])
    .factory('focus', ['$timeout', function($timeout) {
      return function(id) {
        $timeout(function() {
          var element = document.getElementById(id);
          if (element) { element.focus(); }
        });
      }
    }]);
  </script>
  <script>
  angular.module('nln.ui',['nln.ui.tpls', 'nln.ui.typeahead']);
//  angular.module('nln.ui.tpls',['template/typeahead/typa-container.html']);
  angular.module('nln.ui.tpls',['template/typeahead/test-container.html']);
  angular.module('nln.ui.typeahead',['ngResource','nln.ui.utils'])
    //
    // Directives
    .directive('nlnTypaPopup', function () {
      return {
        restrict: 'E'
       ,replace:true
       ,templateUrl: 'template/typeahead/typa-container.html'
      }
    })
    .directive('nlnTypahead', function ($compile) {
      return {
        restrict: 'A'
       ,require:'ngModel'
       ,link: function postLink(originalScope, element, attrs, ngModelCtrl) {
         var inputId = attrs.id;

        // Create child scope
        var scope = originalScope.$new();
        originalScope.$on('$destroy', function(){
          scope.$destroy();
        });


        // Create popup element
        var popUpEl = angular.element('<nln-typa-popup/>');
        popUpEl.attr({
          'input-idref': inputId
        });



         // Compile the popup and attach it to the DOM
         scope.myVar = 'myVar from link';
//         var popup = $compile(popUpEl)(scope);
         var popup = $compile(popUpEl)(originalScope);
         element.after(popup);
       }
      } // return
    });
  </script>

  <script>
    var app = angular.module('typaApp', ['ngResource','nln.ui','nln.ui.utils']);
    //
    // Run
    app.run(['$rootScope', function($rootScope) { 
      $rootScope.limitTo = 8; // TODO should come from the view
      $rootScope.endPoint = 'http://localhost:8070/rs/service';
      $rootScope.resources = {
         authors: '/authors/names'
        ,authorsJ: 'authors.json'
        ,series: '/communities/titles'
      };
    }]);
    //
    // Factories   
    app.factory('Authors', ['$rootScope', '$resource', function($rootScope, $resource) {
//      return resource = $resource($rootScope.resources.authorsJ);
      return $resource($rootScope.endPoint + $rootScope.resources.authors);
    }]);    
    //
    // Controller
    app.controller('AuthorsTypaController', ['$scope', '$rootScope', 'Authors', 'focus',
    function($scope, $rootScope, resource, focus) {
          focus('search-author');

          $scope.myVar = 'myVar from AuthorsTypaCOntroller';
    }]);
    app.controller('SeriesTypaController', ['$scope', '$rootScope', 'Authors', 'focus',
    function($scope, $rootScope, resource, focus) {
    }]);

  </script>
</head>
<body>
  <div ng-controller="AuthorsTypaController">
    <pre>pattern:{{pattern}}</pre>
    <ul ng-model="selectedList">
      <li ng-repeat="item in selectedList">{{item}}</li>
    </ul>
    <input id="search-author" style="width: 234px;" type="text" placeholder="Author name ..." ng-model="pattern"
      ng-change="queryHits()"
      ng-keydown="onKeydown($event)"
      nln-typahead/>
  </div>

  <div ng-controller="SeriesTypaController">
    <pre>pattern:{{pattern}}</pre>
    <ul ng-model="selectedList">
      <li ng-repeat="item in selectedList">{{item}}</li>
    </ul>
    <input id="search-serie" style="width: 234px;" type="text" placeholder="Serie title ..." ng-model="pattern"
      ng-change="queryHits()"
      ng-keydown="onKeydown($event)"/>
    <nln-typa-popup input-idref="search-serie"/>
  </div>

  <script>
  angular.module('template/typeahead/typa-container.html',[])
    .run(['$templateCache', function($templateCache) {
      $templateCache.put('template/typeahead/typa-container.html',
        '<div class="typa-container" ng-show="!isEmpty() && !isForceClose()" style="width: 234px;">\n'+
        '  <div class="typa-item" ng-repeat="item in hitsList | limitTo:8" ng-click="onClick($index, $event)"\n'+
        '    ng-class="{\'active\': isActive($index)}"\n'+
        '    ng-mouseenter="setActive($index)">\n'+
        '    <span class="typa-icon typa-icon-marker"></span>\n'+
        '    <span class="typa-item-query">{{item.name}}</span>\n'+
        '  </div>\n'+
        '</div>\n'+
        '');
    }]);
  angular.module('template/typeahead/test-container.html',[])
    .run(['$templateCache', function($templateCache) {
      $templateCache.put('template/typeahead/typa-container.html',
        '<div class="typa-container" ng-show="!isEmpty() && !isForceClose()" style="width: 234px;">\n'+
        '{{myVar}}\n'+
        '</div>\n'+
        '');
    }]);
  </script>  
</body>
</html>